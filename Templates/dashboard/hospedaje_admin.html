{% extends 'dashboard/base.html' %}

{% block content %}
<div class="container mt-5">
	<div class="d-flex justify-content-between align-items-center mb-2">
		<h2>Hospedaje — Administración</h2>
	</div>
	<div class="inv-accent mb-4"></div>

	<!-- Formulario: Agregar Nueva Habitación (arriba) -->
	<div class="form-card mb-5">
		<div class="form-header">
			<h3> Agregar Nueva Habitación</h3>
			<div class="sub">Complete los detalles de la habitación</div>
		</div>
		<div class="form-body">
			<form action="{{ url_for('admin.hospedaje_nueva') }}" method="POST" enctype="multipart/form-data" class="row g-3">
				<div class="col-md-6">
					<label for="nombre" class="form-label">Nombre de la Habitación <span class="text-danger">*</span></label>
					<input type="text" class="form-control" id="nombre" name="nombre" placeholder="Ej: Suite Deluxe" required>
				</div>
				<div class="col-md-3">
					<label for="plan" class="form-label">Plan</label>
					<select class="form-select" id="plan" name="plan">
						<option value="">Sin plan</option>
						<option value="Oro">Oro</option>
						<option value="Plata">Plata</option>
						<option value="Bronce">Bronce</option>
					</select>
				</div>
				<div class="col-md-3">
					<label for="numero" class="form-label">Número</label>
					<input type="number" class="form-control" id="numero" name="numero" min="1" placeholder="01">
				</div>
				<div class="col-md-6">
					<label for="precio" class="form-label">Precio por Noche <span class="text-danger">*</span></label>
					<input type="number" class="form-control" id="precio" name="precio" min="0" step="0.01" placeholder="$150.000" required>
				</div>
				<div class="col-md-6">
					<label for="cupo_personas" class="form-label">Capacidad de Personas <span class="text-danger">*</span></label>
					<input type="number" class="form-control" id="cupo_personas" name="cupo_personas" min="1" placeholder="2" required>
				</div>
				<div class="col-md-6">
					<label for="estado" class="form-label">Estado <span class="text-danger">*</span></label>
					<select class="form-select" id="estado" name="estado" required>
						<option value="Disponible">Disponible</option>
						<option value="Mantenimiento">Mantenimiento</option>
						<option value="Ocupada">Ocupada</option>
					</select>
				</div>
				<div class="col-12">
					<label class="form-label">Imagen de la Habitación</label>
					<div class="upload-dropzone">
						<button type="button" class="btn btn-cta-gradient" onclick="document.getElementById('imagen').click()">
							<i class="bi bi-folder2-open me-1"></i> Seleccionar Archivo
						</button>
						<span class="ms-2 text-muted small" id="file-name">Ningún archivo seleccionado</span>
						<input type="file" class="form-control mt-2 d-none" id="imagen" name="imagen" accept="image/*">
					</div>
				</div>
				<div class="col-12">
					<label for="descripcion" class="form-label">Descripción</label>
					<textarea class="form-control" id="descripcion" name="descripcion" rows="4" placeholder="Describa las características de la habitación, comodidades, servicios incluidos, etc."></textarea>
				</div>
				<div class="col-12">
					<label for="caracteristicas" class="form-label">Características (JSON o texto)</label>
					<textarea class="form-control" id="caracteristicas" name="caracteristicas" rows="4" placeholder='Ej: {"area_interior": ["Cama King"], "servicios": ["Room service 24h"]}'></textarea>
				</div>
				<div class="col-12">
					<label for="model3d" class="form-label">URL del modelo 3D (GLB, USDZ, etc)</label>
					<input type="url" class="form-control" id="model3d" name="model3d" placeholder="https://.../modelo.glb">
					<small class="text-muted">Opcional. Si se proporciona, se mostrará el modelado 3D en la vista pública.</small>
				</div>
				<div class="col-12 d-flex justify-content-center">
					<button type="submit" class="btn btn-form-primary w-100" style="max-width: 520px;">
						<i class="bi bi-check2-square me-2"></i> Agregar Habitación
					</button>
				</div>
			</form>
		</div>
	</div>

	<!-- Listado de habitaciones por plan (debajo del formulario) -->
	<div id="habitaciones-admin">
		{% for plan, group in habitaciones|groupby('plan') %}
			<div class="col-12">
				<h4 class="mb-3">Plan {{ plan or 'Sin plan' }}</h4>
			</div>
			<div class="row">
			{% for h in group %}
				<div class="col-md-4 mb-4">
					<div class="card habitacion-card estado-{{ h.estado|lower }}" style="min-height: 420px; max-height: 420px; display: flex; flex-direction: column; justify-content: space-between;">
						{% set imgpath = h.imagen if h.imagen else 'img/default.jpg' %}
						<img src="{{ url_for('static', filename=imgpath) }}" class="card-img-top" alt="{{ h.nombre }}" style="height: 200px; object-fit: cover;" onerror="this.onerror=null;this.src='{{ url_for('static', filename='img/default.jpg') }}'">
						<div class="card-body" style="flex: 1 1 auto;">
							<h5 class="card-title">{{ h.nombre }} {% if h.numero %}<span class="text-muted">#{{ '%02d'|format(h.numero) }}</span>{% endif %}</h5>
							<p class="card-text">Plan: {{ h.plan or '—' }}<br>Cupo: {{ h.cupo_personas }}<br>Precio: ${{ '{:,.0f}'.format(h.precio) }} COP</p>
							<div class="card-text" style="max-height: 0; overflow: hidden;">{{ h.descripcion }}</div>
							<button type="button" class="btn btn-link p-0" data-bs-toggle="modal" data-bs-target="#modalHabitacion{{ h.id }}">Leer más</button>
							<span class="badge estado-label {{ h.estado|lower }}">{{ h.estado }}</span>
							<div class="d-flex justify-content-end align-items-end mt-3" style="position: absolute; bottom: 10px; right: 10px; gap: 8px;">
								<a href="{{ url_for('admin.inventario_view') }}?room_id={{ h.id }}" class="btn btn-light btn-sm" title="Inventario"><i class="bi bi-clipboard-check"></i></a>
								<a href="{{ url_for('admin.hospedaje_editar', habitacion_id=h.id) }}" class="btn btn-light btn-sm me-2" title="Editar"><i class="bi bi-pencil-square"></i></a>
								<form action="{{ url_for('admin.hospedaje_eliminar', habitacion_id=h.id) }}" method="POST" style="display:inline;">
									<button type="submit" class="btn btn-light btn-sm" title="Eliminar" onclick="return confirm('¿Seguro que deseas eliminar esta habitación?')"><i class="bi bi-trash"></i></button>
								</form>
							</div>
						</div>
					</div>
				</div>
			{% endfor %}
			</div>
		{% endfor %}
	</div>

	<!-- Modales renderizados fuera del grid -->
	{% for plan, group in habitaciones|groupby('plan') %}
		{% for h in group %}
		<div class="modal fade" id="modalHabitacion{{ h.id }}" tabindex="-1" aria-labelledby="modalHabitacionLabel{{ h.id }}" aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="modalHabitacionLabel{{ h.id }}">{{ h.nombre }}</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
					</div>
					<div class="modal-body">
						{% set model_url = h.model3d %}
						{% if model_url %}
						<model-viewer src="{{ model_url }}" alt="{{ h.nombre }}" camera-controls touch-action="pan-y" ar style="width:100%;height:320px;background:#f8fafc;border-bottom:1px solid #eef2f7" class="mb-3"></model-viewer>
						{% else %}
						{% set imgpath2 = h.imagen if h.imagen else 'img/default.jpg' %}
						<img src="{{ url_for('static', filename=imgpath2) }}" class="img-fluid mb-3" alt="{{ h.nombre }}" onerror="this.onerror=null;this.src='{{ url_for('static', filename='img/default.jpg') }}'">
						{% endif %}
						<p><strong>Plan:</strong> {{ h.plan or '—' }}</p>
						<p><strong>Número:</strong> {{ h.numero or '—' }}</p>
						<p><strong>Cupo:</strong> {{ h.cupo_personas }}</p>
						<p><strong>Precio:</strong> ${{ '{:,.0f}'.format(h.precio) }} COP</p>
						<p><strong>Estado:</strong> {{ h.estado }}</p>
						{% if h.descripcion %}
							<p><strong>Descripción:</strong> {{ h.descripcion }}</p>
						{% else %}
							<p><strong>Descripción:</strong> <span class="text-muted">Sin descripción</span></p>
						{% endif %}
						{% if h.caracteristicas %}
							<hr>
							<pre class="mt-2" style="white-space: pre-wrap;">{{ h.caracteristicas }}</pre>
						{% endif %}
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
					</div>
				</div>
			</div>
		</div>
		{% endfor %}
	{% endfor %}
