{% extends 'usuario/base.html' %}

{% block content %}
<style>
    .reserva-layout { margin-top: 1.5rem; }
    .habitacion-img { width: 100%; height: 260px; object-fit: cover; border-radius: .5rem; }
    .info-chip { display:inline-block; padding: .25rem .5rem; border-radius: 999px; background:#f1f3f5; font-size:.85rem; margin-right:.5rem; }
    #room3d { width: 100%; height: 320px; border-radius: .5rem; overflow: hidden; background: #eef2f7; }
    .btn-reservar { background: linear-gradient(135deg,#ffd166,#fca311); border:none; color:#222; font-weight:700; padding:.75rem 1.25rem; border-radius:.65rem; box-shadow: 0 6px 14px rgba(252,163,17,.25); transition: transform .12s ease, box-shadow .2s ease; }
    .btn-reservar:hover { transform: translateY(-1px); box-shadow:0 10px 18px rgba(252,163,17,.35); color:#111; }
    .card-soft { border:0; box-shadow: 0 6px 20px rgba(0,0,0,.06); border-radius: .75rem; }
    @media (max-width: 991.98px) { #room3d{ height: 260px; } }
    @media (max-width: 575.98px) { .habitacion-img{ height: 200px; } }
    label.required::after{ content:' *'; color:#e03131; }
    .form-section-title{ font-weight:700; font-size:1.05rem; color:#343a40; }
    .mini-muted{ color:#6c757d; font-size:.9rem; }
    .badge-estado{ font-size:.75rem; }
    .precio { font-weight: 800; color:#0b7285; }
    .resumen-item { display:flex; align-items:center; justify-content:space-between; padding:.35rem 0; }
</style>

<div class="container reserva-layout">
    <div class="row g-4 align-items-stretch">
        <!-- Columna izquierda: Imagen, especificaciones y 3D -->
        <div class="col-12 col-lg-6 d-flex flex-column gap-3">
            <div class="card card-soft">
                <div class="card-body">
                    {% set uimg = habitacion.imagen if habitacion.imagen else 'img/default.jpg' %}
                    <img class="habitacion-img mb-3" src="{{ url_for('static', filename=uimg) }}" alt="{{ habitacion.nombre }}" onerror="this.onerror=null;this.src='{{ url_for('static', filename='img/default.jpg') }}'">
                    <h4 class="mb-1">{{ habitacion.nombre }}</h4>
                    <div class="mini-muted">ID Habitación #{{ habitacion.id }}</div>
                    <div class="d-flex align-items-center mt-2 mb-2 flex-wrap">
                        <span class="info-chip"><i class="bi bi-people me-1"></i>{{ habitacion.cupo_personas }} personas</span>
                        <span class="info-chip"><i class="bi bi-cash-coin me-1"></i><span class="precio">${{ '{:,.0f}'.format(habitacion.precio or 0) }}</span> COP/noche</span>
                        <span class="info-chip"><i class="bi bi-circle-half me-1"></i> <span class="badge rounded-pill text-bg-{{ 'success' if habitacion.estado=='Disponible' else 'secondary' }} badge-estado">{{ habitacion.estado }}</span></span>
                    </div>
                    <p class="mb-0">{{ habitacion.descripcion or 'Sin descripción' }}</p>
                </div>
            </div>

            <div class="card card-soft">
                <div class="card-body">
                    <h5 class="mb-3">Vista 3D de la habitación</h5>
                    <div id="room3d"></div>
                    <div class="mini-muted mt-2">Consejos: Arrastra para rotar • Scroll para zoom • Toca para móvil</div>
                </div>
            </div>
        </div>

        <!-- Columna derecha: Formulario -->
        <div class="col-12 col-lg-6 d-flex">
            <div class="card card-soft w-100">
                <div class="card-body">
                    <form method="POST" action="{{ url_for('hospedaje_usuario.reservar_habitacion', habitacion_id=habitacion.id) }}" novalidate>
                        <!-- Resumen de habitación dentro del formulario (solo lectura) -->
                        <div class="mb-3">
                            <div class="form-section-title mb-2">Información de la habitación</div>
                            <div class="resumen-item"><span>ID</span><span>#{{ habitacion.id }}</span></div>
                            <div class="resumen-item"><span>Nombre</span><span>{{ habitacion.nombre }}</span></div>
                            <div class="resumen-item"><span>Precio</span><span class="precio">${{ '{:,.0f}'.format(habitacion.precio or 0) }} COP</span></div>
                            <div class="resumen-item"><span>Cupo</span><span>{{ habitacion.cupo_personas }} personas</span></div>
                        </div>

                        <input type="hidden" name="habitacion_id" value="{{ habitacion.id }}">

                                    <div class="row g-3 align-items-end">
                                        <div class="col-12 col-md-6">
                                            <label class="form-label required">Check-in</label>
                                            <input id="resv-checkin" type="date" class="form-control" name="check_in" required>
                                        </div>
                                        <div class="col-12 col-md-6">
                                            <label class="form-label required">Check-out</label>
                                            <input id="resv-checkout" type="date" class="form-control" name="check_out" required>
                                        </div>
                                        <div class="col-12">
                                            <div id="resv-summary" class="mini-muted"></div>
                                        </div>
                                    </div>

                        <hr class="my-4">

                        <div class="form-section-title mb-2">Datos del huésped</div>
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label required">Nombre completo</label>
                                <input type="text" class="form-control" name="nombre" placeholder="Tu nombre y apellidos" required>
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="form-label required">Tipo de documento</label>
                                <select class="form-select" name="tipoDocumento" required>
                                    <option value="" selected disabled>Selecciona una opción</option>
                                    <option value="Cédula de ciudadanía">Cédula de ciudadanía</option>
                                    <option value="Cédula de extranjería">Cédula de extranjería</option>
                                    <option value="Pasaporte">Pasaporte</option>
                                </select>
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="form-label required">Número de documento</label>
                                <input type="text" inputmode="numeric" pattern="[0-9A-Za-z\-\.]+" class="form-control" name="numeroDocumento" placeholder="Ej. 1234567890" required>
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="form-label required">Teléfono</label>
                                <input type="tel" class="form-control" name="telefono" placeholder="Celular o fijo" required>
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="form-label required">Correo electrónico</label>
                                <input type="email" class="form-control" name="correo" placeholder="tucorreo@ejemplo.com" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label required">Procedencia</label>
                                <input type="text" class="form-control" name="procedencia" placeholder="Ciudad / País" required>
                            </div>
                        </div>

                                                <div class="d-grid mt-4">
                                                    <button id="btn-reservar" class="btn btn-reservar" type="submit">
                                                        <i class="bi bi-calendar2-check me-2"></i><span id="btn-reservar-text">Confirmar reserva y continuar al pago</span>
                                                    </button>
                                                </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Three.js para el modelado 3D (versión del ejemplo) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
    (function() {
        const container = document.getElementById('room3d');
        if (!container || !window.THREE) return;

        let scene, camera, renderer;
        let targetRotationY = 0, targetRotationX = 0; let isDragging=false, mouseX=0, mouseY=0;

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf6f9fc);

            const { width, height } = container.getBoundingClientRect();
            camera = new THREE.PerspectiveCamera(70, width/height, 0.1, 1000);
            camera.position.set(0, 5, 12);
            camera.lookAt(0,2,0);

            renderer = new THREE.WebGLRenderer({ antialias:true });
            renderer.setPixelRatio(window.devicePixelRatio || 1);
            renderer.setSize(width, height);
            renderer.shadowMap.enabled = true;
            container.innerHTML = '';
            container.appendChild(renderer.domElement);

            // Luces
            scene.add(new THREE.AmbientLight(0xffffff, .6));
            const dir = new THREE.DirectionalLight(0xffffff, .8); dir.position.set(5,10,5); dir.castShadow=true; scene.add(dir);
            const warm = new THREE.PointLight(0xffd700, .4); warm.position.set(-3,3,-3); scene.add(warm);

            createRoom(); createBed(); createNightstand(); createLamp(); createWindow(); createDoor(); createPainting(); createRug(); createChair();

            container.addEventListener('mousedown', onDown); container.addEventListener('mousemove', onMove); window.addEventListener('mouseup', onUp);
            container.addEventListener('touchstart', onTouchStart, {passive:true}); container.addEventListener('touchmove', onTouchMove, {passive:true}); container.addEventListener('touchend', onUp);
            window.addEventListener('resize', onResize);

            animate();
        }

        function onResize(){ const r=container.getBoundingClientRect(); camera.aspect=r.width/r.height; camera.updateProjectionMatrix(); renderer.setSize(r.width, r.height); }
        function onDown(e){ isDragging=true; mouseX=e.clientX; mouseY=e.clientY; }
        function onMove(e){ if(!isDragging) return; const dx=e.clientX-mouseX, dy=e.clientY-mouseY; targetRotationY += dx*0.005; targetRotationX += dy*0.005; mouseX=e.clientX; mouseY=e.clientY; }
        function onUp(){ isDragging=false; }
        function onTouchStart(e){ if(e.touches.length===1){ isDragging=true; mouseX=e.touches[0].clientX; mouseY=e.touches[0].clientY; } }
        function onTouchMove(e){ if(e.touches.length===1 && isDragging){ const dx=e.touches[0].clientX-mouseX, dy=e.touches[0].clientY-mouseY; targetRotationY+=dx*0.005; targetRotationX+=dy*0.005; mouseX=e.touches[0].clientX; mouseY=e.touches[0].clientY; } }

        function createRoom(){
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(10,10), new THREE.MeshStandardMaterial({color:0x8b7355, roughness:.85}));
            floor.rotation.x = -Math.PI/2; floor.receiveShadow = true; scene.add(floor);
            const wallMat = new THREE.MeshStandardMaterial({color:0xf5f5dc, side:THREE.DoubleSide});
            const back = new THREE.Mesh(new THREE.PlaneGeometry(10,6), wallMat); back.position.set(0,3,-5); scene.add(back);
            const left = new THREE.Mesh(new THREE.PlaneGeometry(10,6), wallMat); left.rotation.y=Math.PI/2; left.position.set(-5,3,0); scene.add(left);
            const right = new THREE.Mesh(new THREE.PlaneGeometry(10,6), wallMat); right.rotation.y=-Math.PI/2; right.position.set(5,3,0); scene.add(right);
            const roof = new THREE.Mesh(new THREE.PlaneGeometry(10,10), new THREE.MeshStandardMaterial({color:0xffffff})); roof.rotation.x=Math.PI/2; roof.position.y=6; scene.add(roof);
        }
        function createBed(){
            const g=new THREE.Group();
            const base=new THREE.Mesh(new THREE.BoxGeometry(4,.5,3), new THREE.MeshStandardMaterial({color:0x8b4513})); base.position.y=.25; base.castShadow=true; g.add(base);
            const mat=new THREE.Mesh(new THREE.BoxGeometry(3.8,.4,2.8), new THREE.MeshStandardMaterial({color:0xffffff})); mat.position.y=.7; mat.castShadow=true; g.add(mat);
            for(let i=0;i<2;i++){ const p=new THREE.Mesh(new THREE.BoxGeometry(.8,.2,.6), new THREE.MeshStandardMaterial({color:0xe6e6fa})); p.position.set(-1+i*2,1,-.8); p.castShadow=true; g.add(p); }
            const head=new THREE.Mesh(new THREE.BoxGeometry(4,1.5,.2), new THREE.MeshStandardMaterial({color:0x654321})); head.position.set(0,1.25,-1.5); head.castShadow=true; g.add(head);
            g.position.set(0,0,-2); scene.add(g);
        }
        function createNightstand(){ const g=new THREE.Group(); const body=new THREE.Mesh(new THREE.BoxGeometry(.8,1,.6), new THREE.MeshStandardMaterial({color:0x8b4513})); body.position.y=.5; body.castShadow=true; g.add(body); const dr=new THREE.Mesh(new THREE.BoxGeometry(.7,.3,.05), new THREE.MeshStandardMaterial({color:0x654321})); dr.position.set(0,.6,.3); dr.castShadow=true; g.add(dr); g.position.set(-3,0,-2); scene.add(g); }
        function createLamp(){ const g=new THREE.Group(); const base=new THREE.Mesh(new THREE.CylinderGeometry(.1,.15,.05,16), new THREE.MeshStandardMaterial({color:0x333})); g.add(base); const pole=new THREE.Mesh(new THREE.CylinderGeometry(.02,.02,.8,8), new THREE.MeshStandardMaterial({color:0x333})); pole.position.y=.4; g.add(pole); const shade=new THREE.Mesh(new THREE.CylinderGeometry(.2,.25,.3,16), new THREE.MeshStandardMaterial({color:0xffffcc, emissive:0xffff88, emissiveIntensity:.3})); shade.position.y=.95; g.add(shade); g.position.set(-3,1,-2); scene.add(g); }
        function createWindow(){ const g=new THREE.Group(); const frame=new THREE.Mesh(new THREE.BoxGeometry(2,2.5,.1), new THREE.MeshStandardMaterial({color:0x8b4513})); g.add(frame); const glass=new THREE.Mesh(new THREE.PlaneGeometry(1.8,2.3), new THREE.MeshStandardMaterial({color:0x87ceeb, transparent:true, opacity:.3})); glass.position.z=.06; g.add(glass); g.position.set(3,3,-4.95); scene.add(g); }
        function createDoor(){ const g=new THREE.Group(); const frame=new THREE.Mesh(new THREE.BoxGeometry(1.2,2.5,.1), new THREE.MeshStandardMaterial({color:0x654321})); g.add(frame); const handle=new THREE.Mesh(new THREE.SphereGeometry(.05,16,16), new THREE.MeshStandardMaterial({color:0xffd700})); handle.position.set(.4,0,.1); g.add(handle); g.position.set(-3.5,1.25,4.95); g.rotation.y=Math.PI; scene.add(g); }
        function createPainting(){ const g=new THREE.Group(); const frame=new THREE.Mesh(new THREE.BoxGeometry(1.5,1,.05), new THREE.MeshStandardMaterial({color:0x8b7355})); g.add(frame); const canvas=new THREE.Mesh(new THREE.PlaneGeometry(1.3,.8), new THREE.MeshStandardMaterial({color:0x4169e1})); canvas.position.z=.03; g.add(canvas); g.position.set(0,3.5,-4.95); scene.add(g); }
        function createRug(){ const rug=new THREE.Mesh(new THREE.PlaneGeometry(3,2), new THREE.MeshStandardMaterial({color:0xdc143c, roughness:1})); rug.rotation.x=-Math.PI/2; rug.position.set(0,.01,1); scene.add(rug); }
        function createChair(){ const g=new THREE.Group(); const seat=new THREE.Mesh(new THREE.BoxGeometry(.6,.1,.6), new THREE.MeshStandardMaterial({color:0x8b4513})); seat.position.y=.5; seat.castShadow=true; g.add(seat); const back=new THREE.Mesh(new THREE.BoxGeometry(.6,.8,.1), new THREE.MeshStandardMaterial({color:0x8b4513})); back.position.set(0,.95,-.25); back.castShadow=true; g.add(back); for(let i=0;i<4;i++){ const leg=new THREE.Mesh(new THREE.CylinderGeometry(.03,.03,.5,8), new THREE.MeshStandardMaterial({color:0x8b4513})); const x=i%2===0?-0.25:0.25; const z=i<2?-0.25:0.25; leg.position.set(x,.25,z); leg.castShadow=true; g.add(leg);} g.position.set(3,0,2); scene.add(g); }

        function animate(){ requestAnimationFrame(animate); camera.position.x += (Math.sin(targetRotationY)*12 - camera.position.x)*.1; camera.position.z += (Math.cos(targetRotationY)*12 - camera.position.z)*.1; camera.position.y += (5 - targetRotationX*5 - camera.position.y)*.1; camera.lookAt(0,2,0); renderer.render(scene,camera); }

        init();
    })();
</script>

    <script>
        // Cálculo dinámico de noches y total estimado
        (function(){
            const checkin = document.getElementById('resv-checkin');
            const checkout = document.getElementById('resv-checkout');
            const summary = document.getElementById('resv-summary');
            const submitBtn = document.getElementById('btn-reservar');
            const submitText = document.getElementById('btn-reservar-text');
            const precioNoche = {{ (habitacion.precio or 0)|int }};

            function formatCOP(val){
                try { return new Intl.NumberFormat('es-CO').format(val); } catch(e){ return val; }
            }

            function setMins(){
                const today = new Date(); today.setHours(0,0,0,0);
                const isoToday = today.toISOString().slice(0,10);
                if (checkin && !checkin.value) checkin.min = isoToday;
                if (checkout){
                    const base = checkin.value ? new Date(checkin.value) : today;
                    base.setDate(base.getDate()+1);
                    const isoMinOut = base.toISOString().slice(0,10);
                    checkout.min = isoMinOut;
                    if (checkout.value && checkout.value < isoMinOut) checkout.value = '';
                }
            }

            function update(){
                setMins();
                        if (!checkin.value || !checkout.value){
                    summary.textContent = '';
                    submitBtn.disabled = false; // permitimos y el backend aplica mínimo 1 noche
                            if (submitText) submitText.textContent = 'Confirmar reserva y continuar al pago';
                    return;
                }
                const inD = new Date(checkin.value);
                const outD = new Date(checkout.value);
                const ms = outD - inD;
                const nights = Math.round(ms / (1000*60*60*24));
                        if (isNaN(nights) || nights <= 0){
                    summary.innerHTML = '<span class="text-danger">Selecciona una fecha de salida posterior al check-in.</span>';
                    submitBtn.disabled = true;
                            if (submitText) submitText.textContent = 'Confirmar reserva y continuar al pago';
                    return;
                }
                const total = Math.max(1, nights) * precioNoche;
                summary.innerHTML = `Noches: <strong>${nights}</strong> · Total estimado: <strong>$${formatCOP(total)} COP</strong>`;
                submitBtn.disabled = false;
                        if (submitText) submitText.textContent = `Confirmar reserva — $${formatCOP(total)} COP`;
            }

            if (checkin && checkout){
                setMins();
                ['change','input'].forEach(evt => {
                    checkin.addEventListener(evt, update);
                    checkout.addEventListener(evt, update);
                });
                update();
            }
        })();
    </script>

{% endblock %}

