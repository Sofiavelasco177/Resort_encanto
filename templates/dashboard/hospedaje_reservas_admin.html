{% extends 'dashboard/base.html' %}

{% block content %}
<div class="container mt-4">
  <div class="page-header-card mb-3">
    <div>
      <h2 class="title m-0">Reservas de Hospedaje</h2>
      <p class="sub m-0">Administración de reservas y estados</p>
    </div>
    <div class="controls d-flex align-items-center gap-2">
      <form method="get" class="d-flex align-items-center gap-2">
        <select name="estado" class="form-select">
          <option value="">Todos</option>
          {% for st in ['Activa','Completada','Cancelada'] %}
            <option value="{{ st }}" {% if estado==st %}selected{% endif %}>{{ st }}</option>
          {% endfor %}
        </select>
        <button class="btn btn-outline-primary">Filtrar</button>
      </form>
      <div class="btn-group ms-3" role="group" aria-label="Vista">
        <button type="button" class="btn btn-light btn-sm res-view" data-view="cards"><i class="bi bi-grid-3x3-gap me-1"></i>Tarjetas</button>
        <button type="button" class="btn btn-outline-light btn-sm res-view" data-view="table"><i class="bi bi-table me-1"></i>Tabla</button>
      </div>
    </div>
  </div>

  <style>
    .res-grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:768px){.res-grid{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:1200px){.res-grid{grid-template-columns:repeat(3,1fr)}}
    .res-card{background:#fff;border:1px solid #eef2f7;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:12px}
    .res-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .chip{border-radius:999px;padding:4px 10px;font-size:.75rem;font-weight:600;display:inline-block}
    .chip-st{background:#eef2ff;color:#3b82f6}
    .chip-pendiente{background:#fef3c7;color:#d97706}
    .chip-confirmada{background:#d1fae5;color:#059669}
    .chip-pagada{background:#dcfce7;color:#16a34a}
    .chip-cancelada{background:#fee2e2;color:#dc2626}
    .chip-finalizada{background:#f3f4f6;color:#6b7280}
    .meta{display:grid;grid-template-columns:repeat(2,1fr);gap:6px 14px;color:#4b5563}
    .meta .label{font-size:.8rem;color:#9ca3af}
    .actions{display:flex;gap:8px;justify-content:end;margin-top:8px}
    .hidden{display:none!important}
    .res-details{background:#f9fafb;border:1px dashed #e5e7eb;border-radius:12px;margin-top:10px;padding:12px}
    .res-details .title{font-weight:600;color:#374151;margin-bottom:6px}
    .res-details .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px 16px}
    @media(min-width:1200px){.res-details .grid{grid-template-columns:repeat(3,1fr)}}
  </style>

  <!-- Cards view -->
  <div id="res-view-cards" class="res-grid">
    {% for r in reservas %}
    <div class="res-card">
      <div class="res-top">
        <div class="fw-semibold">
          {% if tickets and tickets.get(r.id) %}
            Ticket {{ tickets[r.id].ticket_numero }}
          {% else %}
            Reserva #{{ r.id }}
          {% endif %}
        </div>
        <span class="chip chip-{{ r.estado|lower|replace(' ','-') }}">{{ r.estado }}</span>
      </div>
      <div class="meta">
        <div><div class="label">Check-in</div>{{ r.check_in.strftime('%Y-%m-%d') if r.check_in else '—' }}</div>
        <div><div class="label">Check-out</div>{{ r.check_out.strftime('%Y-%m-%d') if r.check_out else '—' }}</div>
        <div><div class="label">Noches</div>{% if r.check_in and r.check_out %}{{ (r.check_out - r.check_in).days }}{% else %}—{% endif %}</div>
        <div><div class="label">Habitación</div>{{ r.habitacion.nombre if r.habitacion else '—' }}{% if r.habitacion and r.habitacion.numero %} · #{{ r.habitacion.numero }}{% endif %}{% if r.habitacion and r.habitacion.plan %} · {{ r.habitacion.plan }}{% endif %}</div>
        <div><div class="label">Capacidad</div>{{ r.habitacion.cupo_personas if r.habitacion and r.habitacion.cupo_personas else '—' }}</div>
        <div><div class="label">Total</div>${{ '{:,.0f}'.format(r.total or 0) }} COP</div>
      </div>
      {% if r.usuario %}
      <div class="mt-2 pt-2 border-top">
        <div class="label">Cliente</div>
        <div class="fw-medium">{{ r.usuario.usuario }}</div>
        <div class="text-muted small">{% if r.usuario.correo %}{{ r.usuario.correo }}{% else %}—{% endif %}{% if r.usuario.telefono %} · {{ r.usuario.telefono }}{% endif %}</div>
      </div>
      {% endif %}
      <div class="actions">
        <button class="btn btn-sm btn-outline-primary" onclick="viewReservation({{ r.id }})">Ver</button>
        {% if r.estado in ['Activa'] %}
        <button class="btn btn-sm btn-success" onclick="confirmReservation({{ r.id }})">Marcar como Completada</button>
        {% endif %}
        {% if r.estado in ['Activa','Completada'] %}
        <button class="btn btn-sm btn-outline-danger" onclick="cancelReservation({{ r.id }})">Cancelar</button>
        {% endif %}
      </div>
      <!-- Detalles expandibles -->
      <div id="details-card-{{ r.id }}" class="res-details hidden">
        <div class="title">Detalles de la reserva</div>
        <div class="grid">
          <div><div class="label">Reserva</div>#{{ r.id }}</div>
          <div><div class="label">Estado</div>{{ r.estado }}</div>
          <div><div class="label">Ticket</div>{% if tickets and tickets.get(r.id) %}#{{ tickets[r.id].ticket_numero }}{% else %}—{% endif %}</div>
          <div><div class="label">Habitación</div>{{ r.habitacion.nombre if r.habitacion else '—' }}{% if r.habitacion and r.habitacion.numero %} · #{{ r.habitacion.numero }}{% endif %}{% if r.habitacion and r.habitacion.plan %} · {{ r.habitacion.plan }}{% endif %}</div>
          <div><div class="label">Check-in</div>{{ r.check_in.strftime('%d/%m/%Y') if r.check_in else '—' }}</div>
          <div><div class="label">Check-out</div>{{ r.check_out.strftime('%d/%m/%Y') if r.check_out else '—' }}</div>
          <div><div class="label">Noches</div>{% if r.check_in and r.check_out %}{{ (r.check_out - r.check_in).days }}{% else %}—{% endif %}</div>
          <div><div class="label">Total</div>${{ '{:,.0f}'.format(r.total or 0) }} COP</div>
          <div><div class="label">Cliente</div>{{ r.usuario.usuario if r.usuario else '—' }}</div>
          <div><div class="label">Contacto</div>{% if r.usuario and (r.usuario.correo or r.usuario.telefono) %}{{ r.usuario.correo or '' }}{% if r.usuario.telefono %}{% if r.usuario.correo %} · {% endif %}{{ r.usuario.telefono }}{% endif %}{% else %}—{% endif %}</div>
        </div>
        {% if tickets and tickets.get(r.id) %}
        <div class="mt-2"><a class="btn btn-sm btn-outline-secondary" href="{{ url_for('admin.hospedaje_reserva_ticket', reserva_id=r.id) }}" target="_blank"><i class="bi bi-file-earmark-arrow-down me-1"></i>Descargar ticket</a></div>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Table view -->
  <div id="res-view-table" class="hidden">
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>ID/Ticket</th>
            <th>Cliente</th>
            <th>Habitación</th>
            <th>Check-in</th>
            <th>Check-out</th>
            <th>Huéspedes</th>
            <th>Total</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for r in reservas %}
          <tr>
            <td>
              {% if tickets and tickets.get(r.id) %}
                #{{ tickets[r.id].ticket_numero }}
              {% else %}
                #{{ r.id }}
              {% endif %}
            </td>
            <td>
              {% if r.usuario %}
                {{ r.usuario.usuario }}
                {% if r.usuario.correo %}
                <br><small class="text-muted">{{ r.usuario.correo }}</small>
                {% endif %}
              {% else %}
                —
              {% endif %}
            </td>
            <td>{{ r.habitacion.nombre if r.habitacion else '—' }}{% if r.habitacion and r.habitacion.numero %}<br><small class="text-muted">#{{ r.habitacion.numero }} · {{ r.habitacion.plan }}</small>{% endif %}</td>
            <td>{{ r.check_in.strftime('%Y-%m-%d') if r.check_in else '—' }}</td>
            <td>{{ r.check_out.strftime('%Y-%m-%d') if r.check_out else '—' }}</td>
            <td>{{ r.habitacion.cupo_personas if r.habitacion and r.habitacion.cupo_personas else '—' }}</td>
            <td>${{ '{:,.0f}'.format(r.total or 0) }} COP</td>
            <td><span class="chip chip-{{ r.estado|lower|replace(' ','-') }}">{{ r.estado }}</span></td>
            <td>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" onclick="viewReservation({{ r.id }})">Ver</button>
                {% if r.estado in ['Activa'] %}
                <button class="btn btn-success" onclick="confirmReservation({{ r.id }})">Marcar como Completada</button>
                {% endif %}
                {% if r.estado in ['Activa','Completada'] %}
                <button class="btn btn-outline-danger" onclick="cancelReservation({{ r.id }})">Cancelar</button>
                {% endif %}
              </div>
            </td>
          </tr>
          <!-- Fila de detalles -->
          <tr id="details-row-{{ r.id }}" class="hidden">
            <td colspan="9">
              <div class="res-details">
                <div class="title">Detalles de la reserva #{{ r.id }}</div>
                <div class="grid">
                  <div><div class="label">Estado</div>{{ r.estado }}</div>
                  <div><div class="label">Ticket</div>{% if tickets and tickets.get(r.id) %}#{{ tickets[r.id].ticket_numero }}{% else %}—{% endif %}</div>
                  <div><div class="label">Habitación</div>{{ r.habitacion.nombre if r.habitacion else '—' }}{% if r.habitacion and r.habitacion.numero %} · #{{ r.habitacion.numero }}{% endif %}{% if r.habitacion and r.habitacion.plan %} · {{ r.habitacion.plan }}{% endif %}</div>
                  <div><div class="label">Check-in</div>{{ r.check_in.strftime('%d/%m/%Y') if r.check_in else '—' }}</div>
                  <div><div class="label">Check-out</div>{{ r.check_out.strftime('%d/%m/%Y') if r.check_out else '—' }}</div>
                  <div><div class="label">Noches</div>{% if r.check_in and r.check_out %}{{ (r.check_out - r.check_in).days }}{% else %}—{% endif %}</div>
                  <div><div class="label">Capacidad</div>{{ r.habitacion.cupo_personas if r.habitacion and r.habitacion.cupo_personas else '—' }}</div>
                  <div><div class="label">Total</div>${{ '{:,.0f}'.format(r.total or 0) }} COP</div>
                  <div><div class="label">Cliente</div>{{ r.usuario.usuario if r.usuario else '—' }}</div>
                  <div><div class="label">Contacto</div>{% if r.usuario and (r.usuario.correo or r.usuario.telefono) %}{{ r.usuario.correo or '' }}{% if r.usuario.telefono %}{% if r.usuario.correo %} · {% endif %}{{ r.usuario.telefono }}{% endif %}{% else %}—{% endif %}</div>
                </div>
                {% if tickets and tickets.get(r.id) %}
                <div class="mt-2"><a class="btn btn-sm btn-outline-secondary" href="{{ url_for('admin.hospedaje_reserva_ticket', reserva_id=r.id) }}" target="_blank"><i class="bi bi-file-earmark-arrow-down me-1"></i>Descargar ticket</a></div>
                {% endif %}
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  {% if not reservas %}
  <div class="text-center py-5">
    <div class="text-muted">
      <i class="bi bi-calendar-x display-1"></i>
      <p class="mt-3">No hay reservas de hospedaje registradas.</p>
    </div>
  </div>
  {% endif %}

</div>

<script>
// Toggle between cards and table view
document.addEventListener('DOMContentLoaded', function() {
    const viewButtons = document.querySelectorAll('.res-view');
    const cardsView = document.getElementById('res-view-cards');
    const tableView = document.getElementById('res-view-table');

    viewButtons.forEach(button => {
        button.addEventListener('click', function() {
            const view = this.getAttribute('data-view');
            
            // Update active button
            viewButtons.forEach(btn => {
                btn.classList.remove('btn-light');
                btn.classList.add('btn-outline-light');
            });
            this.classList.remove('btn-outline-light');
            this.classList.add('btn-light');

            // Show/hide views
            if (view === 'cards') {
                cardsView.classList.remove('hidden');
                tableView.classList.add('hidden');
            } else {
                cardsView.classList.add('hidden');
                tableView.classList.remove('hidden');
            }
        });
    });
});

// Reservation actions
function viewReservation(id) {
  const cardDetails = document.getElementById(`details-card-${id}`);
  if (cardDetails) {
    cardDetails.classList.toggle('hidden');
  }
  const rowDetails = document.getElementById(`details-row-${id}`);
  if (rowDetails) {
    rowDetails.classList.toggle('hidden');
  }
}

function confirmReservation(id) {
    if (confirm('¿Confirmar esta reserva?')) {
    const formData = new URLSearchParams();
    formData.append('estado', 'Completada');
    fetch(`/admin/hospedaje/reservas/${id}/estado`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: formData.toString()
    }).then(response => {
      if (response.ok) {
        location.reload();
      } else {
        alert('Error al actualizar la reserva');
      }
    });
    }
}

function cancelReservation(id) {
    if (confirm('¿Cancelar esta reserva?')) {
    const formData = new URLSearchParams();
    formData.append('estado', 'Cancelada');
    fetch(`/admin/hospedaje/reservas/${id}/estado`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: formData.toString()
    }).then(response => {
      if (response.ok) {
        location.reload();
      } else {
        alert('Error al cancelar la reserva');
      }
    });
    }
}
</script>

{% endblock %}