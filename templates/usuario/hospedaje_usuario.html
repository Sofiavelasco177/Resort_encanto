{% extends 'usuario/base.html' %}

{% block content %}

<div class="container mt-4 hospedaje-usuario">
    {% if habitaciones_por_plan %}
        {% for plan, rooms in habitaciones_por_plan.items() %}
            {% if rooms %}
                <div class="rooms-grid-2" id="habitaciones-usuario-{{ plan|lower }}">
                    {% for h in rooms %}
                        <article class="room-card-v2">
                            <div class="room-media">
                                {#
                                  Usar helper media_url que resuelve correctamente rutas de instance/uploads,
                                  legacy static e incluso URLs absolutas. Esto garantiza que los cambios de imagen
                                  al editar una habitación se reflejen en esta vista sin problemas de caché.
                                #}
                                {% set uimg = media_url(h.imagen) if h.imagen else url_for('static', filename='img/default.jpg') %}
                                <img src="{{ uimg }}" alt="{{ h.nombre }}" onerror="this.onerror=null;this.src='{{ url_for('static', filename='img/default.jpg') }}'">
                            </div>
                            <div class="room-index-title">
                                <div class="room-index">{{ '%02d'|format(loop.index) }}</div>
                                <h3 class="room-title mb-0">{{ h.nombre }}</h3>
                            </div>
                            <div class="room-meta">
                                <div>Cupo: {{ h.cupo_personas }}{% if h.numero %} · Hab. #{{ '%02d'|format(h.numero) }}{% endif %}</div>
                                <div class="room-price">Desde ${{ '{:,.0f}'.format(h.precio) }} COP</div>
                            </div>
                            <div class="d-flex justify-content-end gap-2 pt-1">
                                <button type="button" 
                                        class="btn btn-outline-secondary modal-trigger-btn" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#modalHabitacion{{ h.id }}">
                                    Especificaciones
                                </button>
                                <a href="{{ url_for('hospedaje_usuario.reservar_habitacion', habitacion_id=h.id) }}" class="room-btn">Reservar</a>
                            </div>
                        </article>
                    {% endfor %}
                </div>
            {% endif %}
        {% endfor %}
    {% else %}
        <div class="rooms-grid-2" id="habitaciones-usuario">
            {% for h in habitaciones %}
                <!-- fallback sin agrupación -->
                <article class="room-card-v2">
                    <div class="room-media">
                        <img src="{{ url_for('static', filename='img/default.jpg') }}" alt="{{ h.nombre }}">
                    </div>
                    <div class="room-index-title">
                        <div class="room-index">{{ '%02d'|format(loop.index) }}</div>
                        <h3 class="room-title mb-0">{{ h.nombre }}</h3>
                    </div>
                    <div class="room-meta">
                        <div>Cupo: {{ h.cupo_personas }}</div>
                        <div class="room-price">Desde ${{ '{:,.0f}'.format(h.precio) }} COP</div>
                    </div>
                    <div class="d-flex justify-content-end gap-2 pt-1">
                        <a href="#" class="btn btn-outline-secondary disabled">Especificaciones</a>
                        <a href="{{ url_for('hospedaje_usuario.reservar_habitacion', habitacion_id=h.id) }}" class="room-btn">Reservar</a>
                    </div>
                </article>
            {% endfor %}
        </div>
    {% endif %}
</div>

<!-- Modales de especificaciones para cada habitación -->
{% if habitaciones_por_plan %}
    {% for plan, rooms in habitaciones_por_plan.items() %}
        {% for h in rooms %}
            {% include 'usuario/habitacion_modal.html' %}
        {% endfor %}
    {% endfor %}
{% else %}
    {% for h in habitaciones %}
        {% include 'usuario/habitacion_modal.html' %}
    {% endfor %}
{% endif %}





<script>
// Script único para manejar todos los modales de habitaciones de forma consistente
document.addEventListener('DOMContentLoaded', function () {
    const triggers = document.querySelectorAll('.modal-trigger-btn');
    let lastTrigger = null;

    triggers.forEach(btn => {
        btn.addEventListener('click', function (e) {
            e.preventDefault();
            const target = btn.getAttribute('data-bs-target');
            if (!target) return;
            const modalEl = document.querySelector(target);
            if (!modalEl) return;

            lastTrigger = btn;

            // Instanciar (o reutilizar) el modal de Bootstrap
            let instance = window.bootstrap && window.bootstrap.Modal.getInstance(modalEl);
            if (!instance && window.bootstrap) {
                instance = new window.bootstrap.Modal(modalEl, {
                    backdrop: true,
                    keyboard: true,
                    focus: true
                });
            }

            if (instance) {
                instance.show();
            } else {
                // Fallback muy básico por si Bootstrap falla
                modalEl.classList.add('show');
                modalEl.style.display = 'block';
                const backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop fade show';
                document.body.appendChild(backdrop);
                const close = () => {
                    modalEl.classList.remove('show');
                    modalEl.style.display = 'none';
                    backdrop.remove();
                };
                modalEl.querySelectorAll('[data-bs-dismiss="modal"], .btn-close').forEach(x => x.addEventListener('click', close, { once: true }));
                backdrop.addEventListener('click', close, { once: true });
                document.addEventListener('keydown', function esc(ev){ if(ev.key==='Escape'){ close(); document.removeEventListener('keydown', esc); } }, { once: true });
            }
        });
    });

    // Ajustes de z-index y retorno de foco cuando se muestran/ocultan
    document.addEventListener('shown.bs.modal', function (ev) {
        const modal = ev.target;
        modal.style.zIndex = '1060';
        const backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) backdrop.style.zIndex = '1055';

        // Foco inicial
        const firstInteractive = modal.querySelector('button, [href], input, select, textarea');
        if (firstInteractive) setTimeout(() => firstInteractive.focus(), 10);
    });

    document.addEventListener('hidden.bs.modal', function () {
        if (lastTrigger) {
            try { lastTrigger.focus(); } catch (e) {}
            lastTrigger = null;
        }
    });
});
</script>

{% endblock %}
