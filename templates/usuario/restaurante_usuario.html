{% extends 'usuario/base.html' %}

{% block content %}

<div class="menu-bg">
  <div class="menu-container">
    <div class="menu-header">
      <h1 class="menu-title">Menú del Restaurante</h1>
      <p class="menu-subtitle">Descubre nuestros deliciosos sabores de platillos</p>
    </div>

    {% if categorias and grupos %}
    <!-- Tabs de categorías -->
    <div class="tabs">
      {% for c in categorias %}
        <button class="tab {% if loop.first %}active{% endif %}" onclick="showCategory('cat-{{ c|replace(' ','-')|lower }}', event)">{{ c }}</button>
      {% endfor %}
    </div>

    {% for c in categorias %}
      {% set items = grupos.get(c, []) %}
      {% if items %}
      <div id="cat-{{ c|replace(' ','-')|lower }}" class="category {% if loop.first %}active{% endif %}">
        <h3 class="cat-title">{{ c }}</h3>

        <div class="menu-grid">
          {% for p in items %}
            <div class="menu-item">
              <div class="item-image">
                {# Muestra imagen si existiera en el modelo, si no, un placeholder #}
                {% set img = p.imagen or p.image or p.foto %}
                {% if img %}
                  <img src="{{ media_url(img) }}" alt="{{ p.nombre }}" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=&quot;placeholder&quot;><i class=&quot;bi bi-image&quot;></i></div>'">
                {% else %}
                  <div class="placeholder">
                    <i class="bi bi-image"></i>
                  </div>
                {% endif %}
              </div>
              
              <div class="item-info">
                <div class="item-name">{{ p.nombre }}</div>
                {% if p.descripcion %}
                  <div class="item-description">{{ p.descripcion }}</div>
                {% else %}
                  <div class="item-description">Delicioso platillo preparado con ingredientes frescos y de la mejor calidad.</div>
                {% endif %}
              </div>
              
              <div class="item-footer">
                <div class="item-price">${{ '{:,.0f}'.format(p.precio or 0) }}</div>
                
                <form method="post" action="{{ url_for('restaurante_cart.cart_add') }}" class="add-form" onsubmit="return onAdd(this)">
                  <div class="item-actions">
                    <div class="quantity-control">
                      <button type="button" class="quantity-btn" onclick="decreaseQuantity(this)">−</button>
                      <input type="number" class="quantity-input" name="cantidad" value="1" min="1">
                      <button type="button" class="quantity-btn" onclick="increaseQuantity(this)">+</button>
                    </div>
                    <input type="hidden" name="plato_id" value="{{ p.id }}">
                    <button type="submit" class="add-btn">Añadir</button>
                  </div>
                </form>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    {% endfor %}

    <div class="cart-cta">
      <a href="{{ url_for('restaurante_cart.view_cart') }}" class="btn">
        <i class="bi bi-cart3 me-2"></i>Ver carrito
      </a>
    </div>

    {% else %}
      <div class="empty-state">
        <i class="bi bi-house"></i>
        <h3>No hay platos disponibles por ahora</h3>
        <p>Pronto tendremos deliciosos platillos para ti</p>
      </div>
    {% endif %}

  </div>
</div>

<script>
  function showCategory(id, ev){
    const cats = document.querySelectorAll('.category');
    const tabs = document.querySelectorAll('.tab');
    cats.forEach(c=> c.classList.remove('active'));
    tabs.forEach(t=> t.classList.remove('active'));
    const el = document.getElementById(id);
    if(el) el.classList.add('active');
    if(ev && ev.target) ev.target.classList.add('active');
    // scroll a la cabecera de la categoría
    if(el){
      const y = el.getBoundingClientRect().top + window.scrollY - 100;
      window.scrollTo({top:y, behavior:'smooth'});
    }
  }
  
  function increaseQuantity(btn){
    const input = btn.parentElement.querySelector('.quantity-input');
    input.value = parseInt(input.value||'1') + 1;
  }
  
  function decreaseQuantity(btn){
    const input = btn.parentElement.querySelector('.quantity-input');
    const v = parseInt(input.value||'1');
    if(v>1) input.value = v-1;
  }
  
  function onAdd(form){
    const btn = form.querySelector('.add-btn');
    if(btn){
      const originalText = btn.textContent;
      btn.textContent = '✓ Añadido';
      btn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
      btn.disabled = true;
      
      setTimeout(()=>{ 
        btn.textContent = originalText; 
        btn.style.background = 'linear-gradient(135deg, #4f7fff 0%, #7b68ee 100%)';
        btn.disabled = false;
      }, 1500);
    }
    return true; // permitir submit
  }

  // Animación de entrada para los elementos del menú
  document.addEventListener('DOMContentLoaded', function() {
    const menuItems = document.querySelectorAll('.menu-item');
    
    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry, index) => {
        if (entry.isIntersecting) {
          setTimeout(() => {
            entry.target.style.opacity = '1';
            entry.target.style.transform = 'translateY(0)';
          }, index * 100);
        }
      });
    }, {
      threshold: 0.1
    });

    menuItems.forEach(item => {
      item.style.opacity = '0';
      item.style.transform = 'translateY(20px)';
      item.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
      observer.observe(item);
    });
  });
</script>
{% endblock %}
